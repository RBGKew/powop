<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
     <changeSet author="ben" id="2011-10-19_04">
      <sql>
        select IFNULL(taxon.lsid_lsid,''), IFNULL(name.nameCache,''), IFNULL(name.authorshipCache,''), IFNULL(lower(rank.titleCache),''), IF(taxon.DTYPE = 'Taxon', 'accepted','synonym'), IFNULL(accepted.lsid_lsid,''), IFNULL(name.genusOrUninomial,''), IFNULL(name.infraGenericEpithet,''), IFNULL(name.specificEpithet,''), IFNULL(name.infraSpecificEpithet,''), concat('http://www.cate-sphingidae.org/taxon/',taxon.uuid) AS source, IF(taxon.updated is NULL, DATE_FORMAT(taxon.created,"%Y-%m-%dT%TZ"),DATE_FORMAT(taxon.updated,"%Y-%m-%dT%TZ")) as updated,DATE_FORMAT(taxon.created,"%Y-%m-%dT%TZ") as created,IFNULL(parent.lsid_lsid,'') as parent_id, IFNULL(IF(name.nomenclaturalmicroreference IS NULL,reference.titleCache,concat(reference.titleCache," ", name.nomenclaturalmicroreference)),'') as citation, IFNULL(IF(reference.uuid IS NULL,NULL,concat('http://www.cate-sphingidae.org/reference/',reference.uuid)),'') as citationId, if(status.type_id IS NULL,'', IF(status.type_id=1963,'nom. illeg.',IF(status.type_id=1960,'nom. invalid.',IF(status.type_id=1947,'nom. provis.',IF(status.type_id=1952,'nom. nudum.','unknown status'))))) as status into outfile '/var/tmp/taxon.txt' FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n'  from taxonbase as taxon join taxonnamebase as name on (taxon.taxonName_fk = name.id) join DefinedTermBase as rank on (name.rank_id = rank.id)  left join synonymrelationship on (taxon.id = synonymrelationship.relatedfrom_id) left join taxonbase as accepted on (accepted.id = synonymrelationship.relatedto_id) left join taxonrelationship on (taxon.id = taxonrelationship.relatedfrom_id) left join taxonbase as parent on (parent.id = taxonrelationship.relatedto_id) join reference on (name.nomenclaturalreference_id = reference.id) left join taxonnamebase_nomenclaturalstatus as name_status on (name.id = name_status.TaxonNameBase_id) left join nomenclaturalstatus as status on (name_status.status_id = status.id);
      </sql>
    </changeSet>    
   <changeSet author="ben" id="2011-10-19_05">
      <sql>
        create temporary table description select element.id as id, concat('http://cate-sphingidae.org/descriptionelement/',element.uuid) as identifier, IFNULL(taxon.lsid_lsid,'') AS lsid, CASE feature_id WHEN 1536 THEN '27 Valve Text' WHEN 1537 THEN '25 Male Genitalia' WHEN 1538 THEN '31 Diagnosis' WHEN 1540 THEN '20 Female Forewing Upperside' WHEN 1543 THEN '17 Female Habitus' WHEN  1545 THEN '18 Female Body Upperside' WHEN 1546 THEN '19 Female Body Underside' WHEN 1547 THEN '24 Female Forewing Length' WHEN 1549 THEN '23 Female Hindwing Underside' WHEN 1550 THEN '22 Female Hindwing Upperside' WHEN 1551 THEN '21 Female Forewing Underside' WHEN 1554 THEN '15 Male Hindwing Underside' WHEN 1555 THEN '14 Male Hindwing Upperside' WHEN 1557 THEN '11 Male Body Underside' WHEN 1558 THEN '10 Male Body Upperside' WHEN 1559 THEN '09 Male Habitus' WHEN 1561 THEN '12 Male Forewing Upperside' WHEN 1562 THEN '13 Male Forewing Underside' WHEN 1563 THEN '16 Male Forewing Length' WHEN 1564 THEN '30 Female Genitalia Text' WHEN 1565 THEN '29 Female Genitalia' WHEN 1566 THEN '26 Male Genitalia Text' WHEN 1568 THEN '01 General' WHEN 1570 THEN '04 General Body Underside' WHEN 1571 THEN '03 General Body Upperside' WHEN 1573 THEN '08 General Hindwing Underside' WHEN 1574 THEN '07 General Hindwing Upperside' WHEN 1575 THEN '02 General Habitus' WHEN 1576 THEN '06 General Forewing Underside' WHEN 1577 THEN '05 General Forewing Upperside' WHEN 1578 THEN '32 Diagnosis Comments' WHEN 1579 THEN '33 Distribution' WHEN 1580 THEN '38 Header Images' WHEN 1581 THEN '28 Aedeagus Text' WHEN 1585 THEN '34 Larva' WHEN 1588 THEN '35 Typification' WHEN 1590 THEN '40 Nomenclature' WHEN 1591 THEN '39 Discussion' WHEN 1592 THEN '36 Syntypes String' WHEN 1593 THEN '37 Type Comments' WHEN 1595 THEN '41 Taxonomy' END as subject, CASE feature_id WHEN 1536 THEN 'morphology' WHEN 1537 THEN 'morphology' WHEN 1538 THEN 'diagnostic' WHEN 1540 THEN 'morphology' WHEN 1543 THEN 'morphology' WHEN  1545 THEN 'morphology' WHEN 1546 THEN 'morphology' WHEN 1547 THEN 'morphology' WHEN 1549 THEN 'morphology' WHEN 1550 THEN 'morphology' WHEN 1551 THEN 'morphology' WHEN 1554 THEN 'morphology' WHEN 1555 THEN 'morphology' WHEN 1557 THEN 'morphology' WHEN 1558 THEN 'morphology' WHEN 1559 THEN 'morphology' WHEN 1561 THEN 'morphology' WHEN 1562 THEN 'morphology' WHEN 1563 THEN 'morphology' WHEN 1564 THEN 'morphology' WHEN 1565 THEN 'morphology' WHEN 1566 THEN 'morphology' WHEN 1568 THEN 'morphology' WHEN 1570 THEN 'morphology' WHEN 1571 THEN 'morphology' WHEN 1573 THEN 'morphology' WHEN 1574 THEN 'morphology' WHEN 1575 THEN 'morphology' WHEN 1576 THEN 'morphology' WHEN 1577 THEN 'morphology' WHEN 1578 THEN 'diagnostic' WHEN 1579 THEN 'distribution' WHEN 1580 THEN 'general' WHEN 1581 THEN 'morphology' WHEN 1585 THEN 'biology' WHEN 1588 THEN 'typematerial' WHEN 1590 THEN 'general' WHEN 1591 THEN 'general' WHEN 1592 THEN 'general' WHEN 1593 THEN 'typematerial' WHEN 1595 THEN 'general' END as type, concat('http://www.cate-sphingidae.org/description/',description.uuid) AS source, IF(element.updated is NULL, DATE_FORMAT(element.created,"%Y-%m-%dT%TZ"),DATE_FORMAT(element.updated,"%Y-%m-%dT%TZ")) as updated, DATE_FORMAT(element.created,"%Y-%m-%dT%TZ") as created, IFNULL(user.emailaddress,'') as creator, "CC BY-NC-SA 3.0" as license, "EN" as language, REPLACE(REPLACE(IFNULL(string.text,''),'\r\n','\n'),'\n',' ') as text, IFNULL(IF(source.citationMicroReference IS NULL,reference.titleCache,concat(reference.titleCache,' ',source.citationMicroReference)),'') as citation, IFNULL(IF(reference.uuid IS NULL,NULL,concat('http://www.cate-sphingidae.org/reference/',reference.uuid)),'') as citationId from descriptionelementbase as element join descriptionbase as description on (element.indescription_id = description.id) join taxonbase as taxon on (description.taxon_fk = taxon.id) left join useraccount as user on (user.id = element.createdBy_id) join descriptionelementbase_languagestring as deb_ls on (element.id = deb_ls.DescriptionElementBase_id) join languagestring as string on (deb_ls.multilanguagetext_id = string.id and string.language_id = 116) left join originalsourcebase as source on (element.id = source.sourcedObj_id AND source.sourcedObj_type = "eu.etaxonomy.cdm.model.description.TextData") left join Reference as reference on (source.citation_id = reference.id) where element.DTYPE = 'TextData' and feature_id in (1536, 1537, 1538, 1540, 1543, 1545, 1546, 1547, 1549, 1550, 1551, 1554, 1555, 1557, 1558, 1559, 1561, 1562, 1563, 1564, 1565, 1566, 1568, 1570, 1571, 1573, 1574, 1575, 1576, 1577, 1578, 1579, 1580, 1581, 1585, 1588, 1590, 1591, 1592, 1593, 1595);
        CREATE TABLE `condensed_description` (`id` int(11) NOT NULL DEFAULT '0', `identifier` varchar(82) DEFAULT NULL, `lsid` varchar(255) NOT NULL DEFAULT '', `subject` varchar(26) DEFAULT NULL, `type` varchar(12) DEFAULT NULL, `source` varchar(79) DEFAULT NULL, `updated` varchar(20) DEFAULT NULL, `created` varchar(20) DEFAULT NULL, `creator` varchar(255) NOT NULL DEFAULT '', `license` varchar(15) NOT NULL DEFAULT '', `language` varchar(2) NOT NULL DEFAULT '', `text` longtext, `citation` varchar(511) NOT NULL DEFAULT '', `citationId` varchar(77) NOT NULL DEFAULT '');
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "morphology" group by lsid;
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "diagnostic" group by lsid;
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "distribution" group by lsid;
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "biology" group by lsid;
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "typematerial" group by lsid;
        insert into condensed_description (lsid, identifier, type, source, updated, created, creator, text, citation, citationId) select lsid, identifier, type, source, updated, created, creator, group_concat(text order by subject separator " "), group_concat(citation,","), group_concat(citationId,",") from description where type = "general" group by lsid;
        select lsid, identifier, type, source, updated, created, creator,text INTO OUTFILE '/var/tmp/description.txt' FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' from condensed_description;
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-10-19_06">
      <sql>
	        create temporary table distribution select element.id as id, concat('http://cate-sphingidae.org/descriptionelement/',element.uuid) as identifier, IFNULL(taxon.lsid_lsid,'') AS lsid, CASE status_id WHEN 2010 THEN 'present' WHEN 2012 THEN 'doubtful' WHEN 2013 THEN 'present' WHEN 2014 THEN 'present' WHEN 2015 THEN 'present' WHEN  2016 THEN 'absent' WHEN 2017 THEN 'rare' WHEN 2018 THEN 'present' WHEN 2019 THEN 'doubtful' WHEN 2020 THEN 'rare' WHEN 2021 THEN 'present' WHEN 2022 THEN 'absent' WHEN 2023 THEN 'present' WHEN 2024 THEN 'present' WHEN 2027 THEN 'present' END as occurrenceStatus, CASE status_id WHEN 2013 THEN 'introduced' WHEN 2015 THEN 'native' WHEN 2017 THEN 'native' WHEN 2018 THEN 'native' WHEN 2020 THEN 'introduced' WHEN 2021 THEN 'naturalised' WHEN 2022 THEN 'native' WHEN 2023 THEN 'native' WHEN 2024 THEN 'uncertain' WHEN 2027 THEN 'uncertain' END as establishmentMeans, CASE status_id WHEN 2012 THEN 'reported but presence questionable' WHEN 2013 THEN 'introduced: formerly introduced' WHEN 2014 THEN 'migrant' WHEN  2016 THEN 'reported in error' WHEN 2017 THEN 'vagrant/stray: natural origin' WHEN 2018 THEN 'present but not yet databased' WHEN 2019 THEN 'recorded but identification unconfirmed' WHEN 2020 THEN 'vagrant/stray: anthropogenic origin' WHEN 2021 THEN 'introduced: anthropogenic origin, established' WHEN 2022 THEN 'native: formerly native' WHEN 2023 THEN 'introduced: natural origin, established' WHEN 2024 THEN 'introduced: uncertain origin, established' WHEN 2027 THEN 'introduced: uncertain degree of naturalisation' END as occurrenceRemarks, concat('http://www.cate-sphingidae.org/description/',description.uuid) AS source, IF(element.updated is NULL, DATE_FORMAT(element.created,"%Y-%m-%dT%TZ"),DATE_FORMAT(element.updated,"%Y-%m-%dT%TZ")) as updated, DATE_FORMAT(element.created,"%Y-%m-%dT%TZ") as created, IFNULL(user.emailaddress,'') as creator, "CC BY-NC-SA 3.0" as license, concat('TDWG:',rep.abbreviatedLabel) as locationId, IFNULL(IF(source.citationMicroReference IS NULL,reference.titleCache,concat(reference.titleCache,' ',source.citationMicroReference)),'') as citation, IFNULL(IF(reference.uuid IS NULL,NULL,concat('http://www.cate-sphingidae.org/reference/',reference.uuid)),'') as citationId from descriptionelementbase as element join descriptionbase as description on (element.indescription_id = description.id) join taxonbase as taxon on (description.taxon_fk = taxon.id) left join useraccount as user on (user.id = element.createdBy_id) join definedtermbase as area on (element.area_id = area.id) join definedtermbase_representation as dtb_rep on (area.id = dtb_rep.definedtermbase_id) join representation as rep on (dtb_rep.representations_id = rep.id) left join originalsourcebase as source on (element.id = source.sourcedObj_id AND source.sourcedObj_type = "eu.etaxonomy.cdm.model.description.Distribution") left join Reference as reference on (source.citation_id = reference.id) where element.DTYPE = 'Distribution';
	        select lsid, identifier, source, updated, created, creator,locationId,occurrenceStatus, IFNULL(establishmentMeans,'') INTO OUTFILE '/var/tmp/distribution.txt' FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' from distribution group by id;
      </sql>
    </changeSet>
     <changeSet author="ben" id="2011-10-19_07">
      <sql>
        select IFNULL(taxon.lsid_lsid,''), CONCAT('/var/www/html/cate-sphingidae/images/',substring_index(uri,'.',1),'.jp2'), IFNULL(media.titleCache,''), IFNULL(artist.titleCache,''), IFNULL(IF(media.updated is NULL, DATE_FORMAT(media.created,"%Y-%m-%dT%TZ"),DATE_FORMAT(media.updated,"%Y-%m-%dT%TZ")),'') as updated, IFNULL(DATE_FORMAT(media.created,"%Y-%m-%dT%TZ"),'') as created INTO OUTFILE '/var/tmp/images.txt' FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' from media join mediarepresentation as rep on (media.id = rep.media_id) join mediarepresentationpart as part on (rep.id = part.representation_id) left join AgentBase as artist on (media.artist_id = artist.id) left join descriptionelementbase_media as deb_media on (media.id = deb_media.media_id) left join descriptionelementbase as element on (element.id = deb_media.DescriptionElementBase_id) left join DescriptionBase as description on (element.indescription_id = description.id) left join taxonbase as taxon on (description.taxon_fk = taxon.id);
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-12-20_08">
        <comment>Export the references</comment>
        <sql>
            select IFNULL(taxon.lsid_lsid,'') as id, IF(ref.updated is NULL, DATE_FORMAT(ref.created,"%Y-%m-%dT%TZ"),DATE_FORMAT(ref.updated,"%Y-%m-%dT%TZ")) as updated, DATE_FORMAT(ref.created,"%Y-%m-%dT%TZ") as created, IFNULL(IF(ref.uuid IS NULL,NULL,concat('http://www.cate-sphingidae.org/reference/',ref.uuid)),'') as identifier, ifnull(ref.titleCache,'') as bibliographicCitation, CASE ref.refType WHEN 0 THEN 'publication' WHEN 1 THEN 'publication' WHEN 2 THEN 'publication' WHEN 3 THEN 'other' WHEN 4 THEN 'other' WHEN 5 THEN 'publication' WHEN 7 THEN 'publication' WHEN 8 THEN  'other' WHEN 10 THEN 'expert' WHEN 11 THEN 'publication' WHEN 15 THEN 'website' WHEN 16 THEN 'publication'  END as type, ifnull(ref.title,'') as title, ifnull(ref.volume,'') as volume, ifnull(ref.series,'') as series, ifnull(ref.pages,'') as pages, REPLACE(REPLACE(IFNULL(ref.referenceAbstract,''),'\r\n','\n'),'\n',' ') as abstract, ifnull(substr(ref.datepublished_start,1,4),'') as date,ifnull(inref.title,'') as source, ifnull(authors.titleCache,'') as creator INTO OUTFILE '/var/tmp/reference.txt' FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' from reference as ref left join reference as inref on (ref.inreference_id= inref.id) join agentbase as authors on (ref.authorTeam_id = authors.id) join originalsourcebase as source on (source.citation_id = ref.id) join descriptionelementbase as element on (source.sourcedObj_id = element.id and source.sourcedObj_type = 'eu.etaxonomy.cdm.model.description.TextData') join descriptionbase as description on (element.indescription_id = description.id) join taxonbase as taxon on (taxon.id = description.taxon_fk);
        </sql>
    </changeSet>
    <changeSet author="ben" id="2013-09-23_01">
        <comment>Export the specimens</comment>
        <sql>
            select ifnull(t2.lsid_lsid,'') as taxonID, o2.uuid as occurrenceID, if(n.id is NULL, '',concat(n.nameCache,' ', n.authorshipCache)) as scientificName, if(g.timeperiod_start is NULL, '', concat(substring(g.timeperiod_start,1,4),'-',substring(g.timeperiod_start,5,2),'-',substring(g.timeperiod_start,7,2))) as eventDate, CASE o2.lifestage_id  WHEN 1694 THEN 'adult' ELSE '' END as lifestage,IFNULL(g.exactlocation_latitude, '') as decimalLatitude, IFNULL(g.exactlocation_longitude,'') as decimalLongitude, CASE o2.sex_id WHEN 1695 THEN 'male' WHEN 1696 THEN 'undetermined' WHEN 1700 THEN 'female' ELSE '' END as sex, o2.titleCache as title, a.titleCache as recordedBy, IFNULL(o2.catalognumber,"") as catalogNumber, IFNULL(c.name,"") as collectionCode, CASE t.typestatus_id WHEN 2044 THEN 'holotype' WHEN 2045 THEN 'lectotype' WHEN 2047 THEN 'syntype' WHEN 2056 THEN 'type' WHEN 2070 THEN 'type' ELSE '' END as typeStatus, IF(t.typestatus_id = 2070, 'originalDesignation','') as typeDesignationType from specimenorobservationbase as o2 left join derivationevent as d on (d.id = o2.derivationevent_id) left join specimenorobservationbase_derivationevent as o_d on (o_d.derivationevents_id = d.id) left join specimenorobservationbase as o1 on (o1.id = o_d.originals_id) left join Collection as c on (o2.collection_id = c.id) left join gatheringevent g on (o1.gatheringevent_id = g.id) left join agentbase a on (g.actor_id = a.id) left join typedesignationbase as t on (o2.id = t.typespecimen_id) left join taxonnamebase_typedesignationbase as t_n on (t.id = t_n.typedesignations_id) left join taxonnamebase as n on (t_n.taxonnamebase_id = n.id) left join taxonbase as t2 on (n.id = t2.taxonname_fk)  where o2.DTYPE = "Specimen" 
        </sql>
    </changeSet>
</databaseChangeLog>
