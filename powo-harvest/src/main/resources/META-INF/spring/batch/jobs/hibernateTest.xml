<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:batch="http://www.springframework.org/schema/batch" xmlns:context="http://www.springframework.org/schema/context" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
    http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">

  <context:property-placeholder ignore-resource-not-found="true" location="classpath*:META-INF/spring/application.properties" />
  <context:annotation-config />

  <batch:job id="hibernateTest">
    <batch:step id="load">
      <batch:tasklet>
        <batch:chunk reader="jpaItemReader" processor="processor" writer="writer" commit-interval="10" />
      </batch:tasklet>
      
      <batch:listeners>
        <batch:listener ref="chunkPerformanceLoggingListener" />
      </batch:listeners>
    </batch:step>
  </batch:job>
  
  <bean id="hibernateReader" class="org.springframework.batch.item.database.HibernatePagingItemReader" scope="step">
    <property name="sessionFactory" ref="sessionFactory" />
    <property name="useStatelessSession" value="false" />
    <property name="queryString" value="from Taxon" />
  </bean>

  <bean id="jpaItemReader" class="org.springframework.batch.item.database.JpaPagingItemReader" scope="step">
    <property name="entityManagerFactory" ref="entityManagerFactory" />
    <!-- "from Taxon t" below works without OOM error -->
    <!-- <property name="queryString" value="from Taxon t"></property> -->
    <!-- "from Taxon t left join fetch t.authority" below works without OOM error -->
    <property name="queryString" value="from Taxon t join fetch t.authority"></property>
    <!-- <property name="queryString" value="from Taxon t where t.identifier = 'urn:lsid:indexfungorum.org:names:808884'"></property> -->
    <!-- <property name="queryString" value="from Taxon t left join fetch t.authority where t.identifier = 'urn:lsid:indexfungorum.org:names:808884'"></property> -->
  </bean>

  <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
    <property name="dataSource" ref="dataSource" />
    <property name="packagesToScan" value="org.powo.model" />
    <property name="jpaVendorAdapter">
      <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter" />
    </property>
  </bean>

  <bean id="processor" class="org.powo.job.TaxonToSolrInputDocumentProcessor" scope="step" />

  <bean id="writer" class="org.powo.job.LoggingWriter" scope="step" />

</beans>