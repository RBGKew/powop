<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet id="2021-08-27_1" author="jds10kg">
    <comment>Add taxon_organisation table. Allows taxa to be linked to multiple organisations.</comment>
    <createTable tableName="taxon_organisation">
      <column name="taxon_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="organisation_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="2021-08-27_2" author="jds10kg">
    <addUniqueConstraint columnNames="taxon_id, organisation_id" constraintName="taxon_organisation_unique_idx" tableName="taxon_organisation"/>
  </changeSet>
  <changeSet id="2021-10-21_1" author="mst10kg">
    <createIndex tableName="resource" indexName="Resource_identifier_IDX" unique="true">
      <column name="identifier" />
    </createIndex>
  </changeSet>
  <changeSet id="2021-10-29_1" author="mst10kg">
    <comment>
      Change sequence generation from lots of custom sequences (and a legacy hibernate_sequences table) to just use hibernate_sequence.
      This may improve performance by enabling JDBC batching see https://docs.jboss.org/hibernate/orm/5.3/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-identity
      and also makes the database and model simpler. We use custom sql scripts because the `createSequence` and `dropSequence` change types
      ✨do not work✨.
    </comment>
    <dropTable tableName="hibernate_sequences" />
    <sql>
      DROP SEQUENCE seq_vernacularname;
      DROP SEQUENCE seq_taxon;
      DROP SEQUENCE seq_annotation;
      DROP SEQUENCE seq_description;
      DROP SEQUENCE seq_distribution;
      DROP SEQUENCE seq_identification;
      DROP SEQUENCE seq_image;
      DROP SEQUENCE seq_measurementorfact;
      DROP SEQUENCE seq_organisation;
      DROP SEQUENCE seq_reference;
      DROP SEQUENCE seq_resource;
    </sql>
    <sql>
      CREATE SEQUENCE hibernate_sequence;
    </sql>
  </changeSet>
</databaseChangeLog>